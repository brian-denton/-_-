# API Routes

This directory contains **serverless functions** that power the public and
internal REST endpoints of the application. Each route is a standalone
TypeScript module located under `src/app/api/**/route.ts` and is automatically
mapped to an HTTP path by Next.js.

| Endpoint                | File                        | Methods                 | Purpose                                                          |
| ----------------------- | --------------------------- | ----------------------- | ---------------------------------------------------------------- |
| `/api/generate-content` | `generate-content/route.ts` | `GET`, `POST`           | Generates or re-generates AI-powered landing-page content.       |
| `/api/logs`             | `logs/route.ts`             | `GET`, `POST`, `DELETE` | CRUD interface for application logs stored in PostgreSQL.        |
| `/api/edge-logs`        | `edge-logs/route.ts`        | `GET`, `POST`           | Receives log entries emitted by Edge Runtime (`edge-logger.ts`). |

---

## 1. `/api/generate-content`

### GET

_Headers_

| Header               | Value                                           | Description               |
| -------------------- | ----------------------------------------------- | ------------------------- |
| `x-theme` (optional) | `brutal` \| `chaos` \| `random` \| `aggressive` | Forces the content theme. |

_Response_

```jsonc
{
  "success": true,
  "content": {
    /* GeneratedContent */
  },
  "metadata": {
    "generatedAt": "2025-06-18T18:54:22.123Z",
    "generationTime": 453, // ms
    "model": "Ollama",
    "version": "2.0.0",
    "aiGenerated": true,
    "confidence": 0.82
  }
}
```

### POST (Manual Regeneration)

```jsonc
{
  "forceRegenerate": true,
  "theme": "chaos" // optional
}
```

_Returns_ – same shape as `GET`.

### Internal Dependencies

| Module                               | Why                                      |
| ------------------------------------ | ---------------------------------------- |
| `src/lib/ai/content-generator.ts`    | Produces the `GeneratedContent` payload. |
| `src/lib/logger/index.ts` (`logger`) | Logs request lifecycle & metadata.       |

### Consumers

- `src/hooks/use-dynamic-content.ts` – calls endpoint from the client.
- `BrutalistHero` component – indirectly via the hook.

---

## 2. `/api/logs`

| Method   | Parameters                                                | Description                                      |
| -------- | --------------------------------------------------------- | ------------------------------------------------ |
| `GET`    | Query: `level?`, `limit?`, `offset?`, `userId?`, `since?` | Reads logs with optional filtering & pagination. |
| `POST`   | Body: `{ level, message, meta?, userId? }`                | Writes a new log entry at the specified level.   |
| `DELETE` | Query: `days?` (default **30**)                           | Deletes logs older than _N_ days.                |

`level` accepts `debug`, `info`, `warn`, `error`.

### Internal Dependencies

| Module                                                        | Why                                          |
| ------------------------------------------------------------- | -------------------------------------------- |
| `src/lib/db` (`db`, `logsTable`)                              | Performs SQL selects/inserts/deletes.        |
| `src/lib/logger/index.ts` (`createRequestLogger`, `logError`) | Structured logging with per-request context. |

### Consumers

- Developer tooling (e.g., log viewer UI) – **not** included in repo but can hit the endpoint.
- `PostgresTransport` uses the same table for writes; this route exposes read / cleanup APIs.

---

## 3. `/api/edge-logs`

### POST

Accepts an _EdgeLogEntry_ generated by `edge-logger.ts` and forwards it to the
main Winston logger.

```jsonc
{
  "timestamp": "2025-06-18T18:54:22.123Z",
  "level": "info",
  "message": "GET / 200 12ms",
  "context": {
    /* EdgeRequestContext */
  },
  "metadata": {
    /* LogMetadata */
  }
}
```

### GET

Health-check endpoint – returns `{ status: "ok" }`.

### Internal Dependencies

| Module                               | Why                                                              |
| ------------------------------------ | ---------------------------------------------------------------- |
| `src/lib/logger/index.ts` (`logger`) | Writes received edge logs into the same pipeline as server logs. |
| `src/lib/logger/types.ts`            | Provides the `LogMetadata` interface for type safety.            |

### Producers

- `src/lib/logger/edge-logger.ts` – sends logs here via `fetch` when
  `EDGE_LOG_ENDPOINT` env variable is set.
- `middleware.ts` – utilises edge logger to record every incoming request.

---

## Request → Logging Flow

```mermaid
graph TD
    subgraph Edge Runtime
        MW[middleware.ts] --> EL[edge-logger.ts]
        EL --POST--> API_EDGE[/api/edge-logs]
    end

    API_EDGE --> LoggerCore[(logger)]
    API_GEN[/api/generate-content] --> LoggerCore
    API_LOGS[/api/logs] --> LoggerCore
    LoggerCore --> PostgresTransport
    PostgresTransport --> DB[(logsTable)]
```

---

## Extending API Routes

1. **Add new endpoint** – create `src/app/api/<name>/route.ts` and export handler
   functions (`GET`, `POST`, etc.).
2. **Leverage logger** – import `{ extractRequestContext, createRequestLogger }` to get contextual logs.
3. **Database access** – import `{ db }` and relevant tables from `src/lib/db` for type-safe SQL.

---

Made with 🛠️ + Next.js API Routes.
